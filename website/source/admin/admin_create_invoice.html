<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Créer une Facture - Admin - Maison Trüvra</title>
    <link rel="stylesheet" href="css/admin_style.css"> <!-- Assuming CSS is in admin/css/ -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
</head>
<body class="admin-body" id="page-admin-create-invoice">

    <header class="admin-page-header-bar">
        <div class="container">
            <div class="flex items-center space-x-4">
                <a href="admin_dashboard.html" id="back-to-dashboard-button" class="btn btn-admin-secondary btn-sm flex items-center">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Retour au Tableau de Bord
                </a>
                <div id="admin-header-title-area">
                     <h1 class="text-xl font-semibold">Maison Trüvra - Admin</h1>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <span id="admin-user-greeting" class="text-sm mr-2"></span>
                <button id="admin-logout-button" class="btn btn-admin-danger btn-sm flex items-center">
                    <i class="fas fa-sign-out-alt mr-2"></i>Déconnexion
                </button>
            </div>
        </div>
    </header>

    <nav class="admin-main-nav">
        <div class="container">
            <div class="nav-links-container">
                <a href="admin_dashboard.html" class="admin-nav-link">Tableau de Bord</a>
                <a href="admin_manage_products.html" class="admin-nav-link">Produits</a>
                <a href="admin_manage_inventory.html" class="admin-nav-link">Inventaire</a>
                <a href="admin_view_inventory.html" class="admin-nav-link">Voir Inventaire</a>
                <a href="admin_manage_orders.html" class="admin-nav-link">Commandes</a>
                <a href="admin_manage_users.html" class="admin-nav-link">Utilisateurs</a>
                <a href="admin_manage_categories.html" class="admin-nav-link">Catégories</a>
                <a href="admin_invoices.html" class="admin-nav-link active">Factures</a>
                <a href="admin_manage_reviews.html" class="admin-nav-link">Avis</a>
                <a href="admin_profile.html" class="admin-nav-link">Mon Profil</a>
            </div>
        </div>
    </nav>

    <div class="admin-main-container invoice-page-container">
        <header class="invoice-page-header">
            <h1>Créer une Nouvelle Facture Manuelle</h1>
        </header>

        <div class="invoice-layout">
            <!-- Invoice Form Section -->
            <section class="admin-form-container invoice-form-section">
                <form id="create-invoice-form" class="admin-form">
                    <div class="form-group">
                        <label for="professional-user-select" class="form-label">Client Professionnel :</label>
                        <select id="professional-user-select" name="b2b_user_id" class="form-input-admin">
                            <option value="">Sélectionnez un client</option>
                            <!-- Options populated by JS -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="admin-invoice-notes" class="form-label">Notes / Informations complémentaires (pour la facture) :</label>
                        <textarea id="admin-invoice-notes" name="notes" class="form-input-admin" rows="3" placeholder="Ex: Conditions spécifiques, références..."></textarea>
                    </div>
                     <div class="form-group">
                        <button type="submit" class="btn btn-admin-primary flex items-center">
                            <i class="fas fa-file-invoice mr-2"></i>Générer & Enregistrer la Facture
                        </button>
                    </div>
                </form>
            </section>

            <!-- Invoice Preview Section -->
            <section class="invoice-preview-container">
                <div class="invoice-preview-header">
                    <div>
                        <img src="../images/maison_truvra_invoice_logo.png" alt="Maison Trüvra Logo" class="company-logo">
                        <div id="company-info-display" class="company-details">
                            <p class="company-brand-name" id="company-name">Maison Trüvra SARL</p>
                            <p class="company-tagline">Propriétaire récoltant</p>
                            <p id="company-address1">1 Rue de la Truffe</p>
                            <p id="company-city-postal-country">75001 Paris, France</p>
                            <p>SIRET: <span id="company-siret">FRXX123456789</span></p>
                            <p>TVA: <span id="company-vat">FRXX123456789</span></p>
                        </div>
                    </div>
                    <div>
                        <h2 class="invoice-title">Facture</h2>
                        <div class="invoice-info">
                            <p><strong>Facture N°:</strong> <span id="invoice-number-display" class="readonly-field d-inline-block" style="min-width: 200px;">En attente</span></p>
                            <p><strong>Date:</strong> <input type="date" id="invoice-date" class="form-input-admin d-inline-block" style="width:auto; padding: 5px;"></p>
                            <p><strong>Date d'échéance:</strong> <input type="date" id="invoice-due-date" class="form-input-admin d-inline-block" style="width:auto; padding: 5px;"></p>
                        </div>
                    </div>
                </div>

                <div class="invoice-customer-info-grid">
                    <div>
                        <h3 class="section-title">Facturé à :</h3>
                        <div id="customer-billing-info" class="customer-details">
                            <p class="font-weight-bold" id="customer-company-name">Nom de l'Entreprise Cliente</p>
                            <p id="customer-contact-name">Prénom Nom (Contact)</p>
                            <div id="customer-billing-address" class="readonly-field" style="min-height: 70px;">Adresse de facturation</div>
                            <p class="mt-2">SIRET: <span id="customer-siret-display" class="readonly-field"></span></p>
                            <p>N° TVA Intra.: <span id="customer-vat-display" class="readonly-field"></span></p>
                        </div>
                    </div>
                    <div>
                        <h3 class="section-title">Livré à :</h3>
                        <div id="customer-delivery-info" class="customer-details">
                            <p class="font-weight-bold" id="delivery-company-name">Nom de l'Entreprise Cliente (Livraison)</p>
                             <div id="customer-delivery-address" class="readonly-field" style="min-height: 70px;">Adresse de livraison</div>
                        </div>
                    </div>
                </div>
                
                <h3 class="section-title">Détails de la facture :</h3>
                <div class="overflow-x-auto">
                    <table class="line-items-table">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th style="width: 10%;">Qté</th>
                                <th style="width: 15%;">Prix Unit. HT (€)</th>
                                <th style="width: 10%;">TVA (%)</th>
                                <th style="width: 15%;">Total HT (€)</th>
                                <th style="width: 15%;">Total TTC (€)</th>
                                <th style="width: 5%;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="invoice-items-tbody">
                            <!-- Line items will be added here by JavaScript -->
                        </tbody>
                    </table>
                </div>
                <button type="button" id="add-invoice-item-btn" class="btn btn-admin-secondary mt-4 btn-sm">
                    <i class="fas fa-plus mr-1"></i> Ajouter une ligne
                </button>

                <div class="invoice-totals-section"> 
                    <div><span>Sous-Total HT :</span> <span id="subtotal-ht">0.00 €</span></div>
                    <div id="vat-summary-container">
                        <!-- VAT per rate will be populated here, e.g. <div><span>TVA (20%):</span> <span>0.00 €</span></div> -->
                    </div>
                    <div><span>Total TVA :</span> <span id="total-vat">0.00 €</span></div>
                    <div class="grand-total"><span>TOTAL TTC :</span> <span id="grand-total-ttc">0.00 €</span></div>
                    <div class="grand-total mt-2"><span>NET À PAYER :</span> <span id="net-to-pay">0.00 €</span></div>
                </div>

                <div class="invoice-payment-info">
                    <h3 class="section-title">Conditions de paiement :</h3>
                    <p>Paiement à réception de facture, au plus tard sous <span id="payment-due-days">30</span> jours.</p>
                    <p>Mode de paiement : Virement bancaire</p>
                    <p><strong>IBAN :</strong> <span id="company-iban">FRXX XXXX XXXX XXXX XXXX XXX</span></p>
                    <p><strong>BIC/SWIFT :</strong> <span id="company-swift">XXXXXXX</span></p>
                    <p class="text-xs mt-3">En cas de retard de paiement, une pénalité égale à 3 fois le taux d'intérêt légal sera appliquée (Décret 2009-138 du 9 février 2009). Pas d'escompte pour paiement anticipé.</p>
                </div>

                <div class="invoice-preview-footer">
                    <p class="font-weight-bold">Maison Trüvra</p>
                    <p>« L’avenir de la truffe, cultivé avec art. »</p>
                    <p class="mt-2">Maison Trüvra SARL - Capital Social : XXXXX € - RCS Paris : XXXXXXXXX - NAF : XXXXX</p>
                    <p>1 Rue de la Truffe, 75001 Paris, France - Tél : +33 X XX XX XX XX - Email : contact@maisontruvra.com</p>
                    <p class="footer-highlight">Merci de votre confiance !</p>
                </div>
            </section>
        </div>
        
        <div class="mt-10 text-center admin-form-container">
            <button type="button" id="preview-invoice-pdf-btn" class="btn btn-admin-secondary">
                <i class="fas fa-eye mr-2"></i>Aperçu PDF (Bientôt)
            </button>
        </div>

    </div>

    <template id="invoice-item-template">
        <tr>
            <td><input type="text" name="item_description[]" class="item-description form-input-admin" placeholder="Description du produit/service"></td>
            <td><input type="number" name="item_quantity[]" class="item-quantity form-input-admin" value="1" min="0.01" step="0.01"></td>
            <td><input type="number" name="item_unit_price_ht[]" class="item-unit-price-ht form-input-admin" value="0.00" min="0" step="0.01"></td>
            <td>
                <select name="item_vat_rate[]" class="item-vat-rate form-input-admin">
                    <option value="20">20%</option>
                    <option value="10">10%</option>
                    <option value="5.5">5.5%</option>
                    <option value="2.1">2.1%</option>
                    <option value="0">0%</option>
                </select>
            </td>
            <td><span class="item-total-ht">0.00</span> €</td>
            <td><span class="item-total-ttc">0.00</span> €</td>
            <td><button type="button" class="remove-item-btn btn btn-admin-danger btn-sm"><i class="fas fa-times"></i></button></td>
        </tr>
    </template>

    <footer class="admin-footer">
        <p>&copy; <span id="currentYearCreateInvoice"></span> Maison Trüvra - Admin Panel</p>
    </footer>
    <div id="admin-toast-container"></div>

    <script src="js/admin_config.js"></script>
    <script src="js/admin_ui.js"></script>
    <script src="js/admin_api.js"></script>
    <script src="js/admin_auth.js"></script>
    <script src="js/admin_main.js"></script>
    <script src="js/admin_create_invoice_js.js"></script>
    <script>
        document.getElementById('currentYearCreateInvoice').textContent = new Date().getFullYear();
        // Ensure preview button ID matches JS if it's 'preview-invoice-btn'
        const previewPdfBtn = document.getElementById('preview-invoice-pdf-btn');
        if (previewPdfBtn && typeof handlePreviewInvoice === 'function') { // Assuming handlePreviewInvoice is in admin_create_invoice_js.js
             previewPdfBtn.addEventListener('click', handlePreviewInvoice);
        }
        // The main submit button is part of the form, its handler is in admin_create_invoice_js.js
    </script>
</body>
</html>
